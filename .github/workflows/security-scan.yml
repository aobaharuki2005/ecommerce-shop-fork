name: Qu√©t b·∫£o m·∫≠t t·ª± ƒë·ªông v·ªõi Trivy v√† SonarQube

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

  

jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602

        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # --- JOB 2: QU√âT TH∆Ø VI·ªÜN (SCA) V·ªöI TRIVY ---
  trivy-scan:
    permissions:
      pull-requests: write
      security-events: write
      contents: read
    name: Trivy Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy (JSON Output)
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac
        with:
          scan-type: 'fs'
          format: 'json'
          output: 'trivy_report.json'
          severity: 'CRITICAL,HIGH'

      - name: Analyze Results & Set Status
        id: analyze
        run: |
          VULN_COUNT=$(jq '[.Results[].Vulnerabilities[]?] | length' trivy_report.json)
          echo "VULN_COUNT=$VULN_COUNT" >> $GITHUB_ENV
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "SCAN_STATUS=‚ùå PH√ÅT HI·ªÜN $VULN_COUNT L·ªñ H·ªîNG (CRITICAL/HIGH)." >> $GITHUB_ENV
          else
            echo "SCAN_STATUS=‚úÖ Project an to√†n. Kh√¥ng t√¨m th·∫•y l·ªó h·ªïng nghi√™m tr·ªçng." >> $GITHUB_ENV
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc
        with:
          message: |
            ## K·∫øt qu·∫£ qu√©t b·∫£o m·∫≠t Trivy (SCA):
            - **Tr·∫°ng th√°i:** ${{ env.SCAN_STATUS }}
            - **T·ªïng s·ªë l·ªó h·ªïng (CRITICAL/HIGH):** `${{ env.VULN_COUNT }}`
            
            üîó [Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ xem chi ti·∫øt v√† t·∫£i b√°o c√°o HTML](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            *Ghi ch√∫: N·∫øu c√≥ l·ªó h·ªïng, vui l√≤ng ki·ªÉm tra m·ª•c **Artifacts** ·ªü cu·ªëi trang link b√™n tr√™n.*

      - name: Generate HTML Report
        if: always()
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac
        with:
          scan-type: 'fs'
          format: 'template'
          template: "@$HOME/.local/bin/trivy-bin/contrib/html.tpl"
          output: 'trivy_report.html'
          severity: 'CRITICAL,HIGH'

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: security-reports
          path: |
            trivy_report.html
            trivy_report.json

      - name: Fail Pipeline if Vulns Found
        if: always()
        run: |
          if [ "${{ env.VULN_COUNT }}" -gt 0 ]; then
            exit 1
          fi

# --- JOB 3: G·ª¨I TH√îNG B√ÅO EMAIL KHI C√ì L·ªñI ---
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    # Job n√†y c·∫ßn k·∫øt qu·∫£ t·ª´ 2 job tr∆∞·ªõc
    needs: [sonarqube, trivy-scan]
    # Ch·ªâ ch·∫°y n·∫øu c√≥ √≠t nh·∫•t 1 job th·∫•t b·∫°i (failure)
    if: failure()
    steps:
      - name: Send Mail
        uses: dawidd6/action-send-mail@4226df7daafa6fc901a43789c49bf7ab309066e7
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫£o m·∫≠t th·∫•t b·∫°i t·∫°i ${{ github.repository }}"
          to: tranbaohnth@outlook.com.vn
          from: GitHub Security Watcher
          body: |
            Ph√°t hi·ªán l·ªói b·∫£o m·∫≠t ho·∫∑c m√£ ngu·ªìn kh√¥ng ƒë·∫°t chu·∫©n!
            
            - Project: ${{ github.repository }}
            - Nh√°nh: ${{ github.ref_name }}
            - Tr·∫°ng th√°i SonarQube: ${{ needs.sonarqube.result }}
            - Tr·∫°ng th√°i Trivy: ${{ needs.trivy-scan.result }}
            
            Chi ti·∫øt t·∫°i: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
